# Discord бот для распознавания слова «блад»

Бот подключается к голосовому каналу, распознаёт речь (через Vosk или Whisper) и отправляет сообщение, когда слышит слово из заданного списка. Для каждого срабатывания указывается участник, голосовой канал и фрагмент фразы (~1 с контекста).

## Возможности
- команды `!join`, `!stop`, `!leave`;
- два варианта распознавания:
  - **Vosk** — CPU‑режим (минимум зависимостей);
  - **Whisper (faster-whisper)** — GPU/RTX, поддержка RTX 40xx, вычисления на CUDA;
- сохраняет сырые голосовые семплы по пользователям для дообучения TTS;
- отслеживание говорящего и упоминание в сообщении;
- настройка текста уведомления, списка слов, задержки между срабатываниями и длины контекстного окна.

## Требования
- Python 3.11+;
- установленный `ffmpeg`;
- для Vosk‑режима — модель из [репозитория Vosk](https://alphacephei.com/vosk/models);
- для Whisper‑режима — видеокарта с поддержкой CUDA (например, RTX 4060) и пакет `faster-whisper`;
- права бота на чтение голосовых каналов и отправку сообщений.

## Установка
```bash
python -m venv .venv
.venv\Scripts\activate          # Windows PowerShell
python -m pip install -U pip
pip install -r requirements.txt
```

Для Vosk скачайте и распакуйте модель (папку `vosk-model-small-ru-0.22`) и укажите путь в `.env`.  
Для Whisper модели загружаются автоматически через `faster-whisper` (доступно указание локального пути/имени модели).

## Настройка
1. Скопируйте пример конфигурации:
   ```bash
   copy .env.example .env
   ```
2. Заполните параметры:
   - `DISCORD_TOKEN` — токен бота;
   - `TARGET_WORDS` — слова через запятую (`блад,blad`);
   - `SPEECH_BACKEND` — `vosk` (CPU) или `whisper` (GPU);
   - для Vosk: `VOSK_MODEL_PATH` — путь к распакованной модели;
   - для Whisper:
     - `WHISPER_MODEL_NAME` — имя/путь модели (например, `small`, `medium`, `large-v3`);
     - `WHISPER_DEVICE` — устройство, по умолчанию `cuda`;
     - `WHISPER_COMPUTE_TYPE` — тип вычислений (`float16` для RTX 40xx);
     - `WHISPER_LANGUAGE` — код языка (например, `ru`), можно оставить пустым для автоопределения;
     - `WHISPER_WINDOW_SECONDS`, `WHISPER_MAX_BUFFER_SECONDS` — размеры анализируемого окна/буфера;
   - `VOICE_SAMPLING_ENABLED` — включить/выключить сбор голосовых семплов;
   - `VOICE_SAMPLE_DIR` — каталог с записанными `.wav` файлами;
   - `VOICE_SAMPLE_SECONDS` — длина одного файла-семпла (по умолчанию 5 с);
   - `DETECTION_MESSAGE` — шаблон сообщения. Доступные плейсхолдеры:
     - `{user}` — упоминание пользователя;
     - `{user_tag}` — «display name / username» или `ID <число>`;
     - `{channel}` — упоминание голосового канала либо его имя;
     - `{word}` — сработавшее слово;
     - `{transcript}` — фрагмент фразы (≈1 с вокруг слова);
   - `DETECTION_COOLDOWN_SECONDS` — минимальный интервал между срабатываниями для одного пользователя;
   - `DETECTION_CONTEXT_SECONDS` — ширина контекстного окна (в секундах).

## Запуск
```bash
python bot.py
```

В Discord:
1. Зайдите в голосовой канал.
2. В текстовом канале вызовите `!join`.
3. Произнесите ключевое слово — бот отправит сообщение с упоминанием говорившего.
4. `!stop` — остановить распознавание (бот остаётся в голосовом канале).
5. `!leave` — полностью отключить бота от канала.

## Примечания
- Распознавание выполняется локально. Whisper на GPU заметно быстрее Vosk, но требует видеокарту и пакет `faster-whisper`.
- При работе на GPU убедитесь, что установлены драйверы NVIDIA/CUDA Toolkit (минимум CUDA 11.2).
- Убедитесь, что использование бота соответствует правилам сервера и законодательству (запись голоса требует согласия участников).

